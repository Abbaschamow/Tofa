<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chamow Chat App</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    *{box-sizing:border-box;font-family:Poppins,Arial,sans-serif;}
    body{margin:0;background:#f0f2f5;}
    .page{display:none;padding:20px;max-width:500px;margin:40px auto;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);}
    .page.active{display:block;}
    input,button{width:100%;margin:8px 0;padding:10px;border:1px solid #ccc;border-radius:8px;}
    button{background:#25D366;color:#fff;border:none;font-weight:600;cursor:pointer;}
    button:hover{opacity:.9;}
    header{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#25D366;color:#fff;border-radius:10px 10px 0 0;}
    .chat-container{display:flex;flex-direction:column;height:80vh;}
    .users-list{border-bottom:1px solid #ccc;max-height:150px;overflow-y:auto;padding:10px;}
    .user{padding:8px;cursor:pointer;border-radius:6px;}
    .user:hover{background:#e2ffc7;}
    .messages{flex:1;overflow-y:auto;padding:10px;}
    .message{margin:5px 0;padding:8px 12px;border-radius:16px;background:#e2ffc7;max-width:70%;}
    .message.me{background:#dcf8c6;margin-left:auto;}
    .input-area{display:flex;}
    .input-area input{flex:1;padding:10px;}
    .input-area button{width:80px;}
    #avatar-preview{width:80px;height:80px;border-radius:50%;object-fit:cover;margin:10px 0;}
    #logout,#backToChat{margin-top:10px;background:#f44336;}
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="loginPage" class="page active">
    <h2>Chamow Chat</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
    <p id="authMessage" style="color:red;"></p>
  </div>

  <!-- CHAT PAGE -->
  <div id="chatPage" class="page">
    <header>
      <h3>Chamow Chat</h3>
      <div>
        <button id="profileBtn">Profile</button>
        <button id="settingsBtn">‚öôÔ∏è</button>
        <button id="logout">Logout</button>
      </div>
    </header>

    <div class="chat-container">
      <div class="users-list" id="usersList"></div>
      <div class="messages" id="messages"></div>
      <div class="input-area">
        <input type="text" id="messageInput" placeholder="Type a message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <!-- PROFILE PAGE -->
  <div id="profilePage" class="page">
    <h2>Edit Profile</h2>
    <img id="avatar-preview" src="" alt="">
    <input type="text" id="username" placeholder="Username">
    <input type="file" id="avatar" accept="image/*">
    <button id="saveProfile">Save Profile</button>
    <button id="backToChat">Back</button>
  </div>

  <!-- SETTINGS PAGE -->
  <div id="settingsPage" class="page">
    <h2>Settings</h2>
    <button id="deleteAccount">Delete Account</button>
    <button id="backSettings">Back</button>
  </div>

  <script>
    // ========== FIREBASE CONFIG ==========
    const firebaseConfig = {
  apiKey: "AIzaSyB1fQdrmOJWDh4dEdQTFucj9BUeQmH_yew",
  authDomain: "whatsapp-web-944f9.firebaseapp.com",
  databaseURL: "https://whatsapp-web-944f9-default-rtdb.firebaseio.com",
  projectId: "whatsapp-web-944f9",
  storageBucket: "whatsapp-web-944f9.firebasestorage.app",
  messagingSenderId: "975370289693",
  appId: "1:975370289693:web:23390019b3b1c216a0fcf4"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // ========== PAGE SWITCHING ==========
    const pages = {
      login: document.getElementById('loginPage'),
      chat: document.getElementById('chatPage'),
      profile: document.getElementById('profilePage'),
      settings: document.getElementById('settingsPage')
    };
    function showPage(name){ Object.values(pages).forEach(p=>p.classList.remove('active')); pages[name].classList.add('active'); }

    // ========== AUTH ==========
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const messageBox = document.getElementById('authMessage');

    loginBtn.onclick = async ()=>{
      try {
        await auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value);
      } catch(e){ messageBox.innerText = e.message; }
    };

    registerBtn.onclick = async ()=>{
      try {
        const userCred = await auth.createUserWithEmailAndPassword(loginEmail.value, loginPassword.value);
        await db.collection("users").doc(userCred.user.uid).set({
          email: loginEmail.value,
          username: loginEmail.value.split('@')[0],
          avatar: "",
          online: true
        });
      } catch(e){ messageBox.innerText = e.message; }
    };

    // ========== AUTH STATE ==========
    auth.onAuthStateChanged(async user=>{
      if(user){
        await db.collection("users").doc(user.uid).update({online:true});
        showPage('chat');
        loadUsers();
      } else {
        showPage('login');
      }
    });

    document.getElementById('logout').onclick = async ()=>{
      const user = auth.currentUser;
      if(user){ await db.collection("users").doc(user.uid).update({online:false}); }
      await auth.signOut();
    };

    // ========== USERS & CHAT ==========
    let currentChatUser = null;

    async function loadUsers(){
      const usersList = document.getElementById('usersList');
      db.collection("users").onSnapshot(snapshot=>{
        usersList.innerHTML = "";
        snapshot.forEach(doc=>{
          if(auth.currentUser && doc.id !== auth.currentUser.uid){
            const u = doc.data();
            const div = document.createElement("div");
            div.classList.add("user");
            div.innerText = `${u.username} ${u.online ? "üü¢":"‚ö´"}`;
            div.onclick = ()=>openChat(doc.id,u.username);
            usersList.appendChild(div);
          }
        });
      });
    }

    function openChat(otherId,otherName){
      currentChatUser = {id: otherId, name: otherName};
      const me = auth.currentUser.uid;
      const chatId = [me, otherId].sort().join("_");
      const messagesDiv = document.getElementById("messages");

      db.collection("chats").doc(chatId).collection("messages").orderBy("time")
      .onSnapshot(snapshot=>{
        messagesDiv.innerHTML="";
        snapshot.forEach(doc=>{
          const m=doc.data();
          const div=document.createElement("div");
          div.classList.add("message");
          if(m.sender===me) div.classList.add("me");
          div.textContent = m.text;
          messagesDiv.appendChild(div);
        });
      });
    }

    document.getElementById('sendBtn').onclick = async ()=>{
      const text = document.getElementById('messageInput').value.trim();
      if(!text || !currentChatUser) return;
      const me = auth.currentUser.uid;
      const chatId = [me, currentChatUser.id].sort().join("_");
      const userDoc = await db.collection("users").doc(me).get();
      await db.collection("chats").doc(chatId).collection("messages").add({
        text,
        sender: me,
        senderName: userDoc.data().username,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
      document.getElementById('messageInput').value = "";
    };

    // ========== PROFILE ==========
    document.getElementById('profileBtn').onclick = ()=>{
      showPage('profile');
      loadProfile();
    };
    document.getElementById('backToChat').onclick = ()=>showPage('chat');

    async function loadProfile(){
      const user = auth.currentUser;
      const docSnap = await db.collection("users").doc(user.uid).get();
      const data = docSnap.data();
      document.getElementById('username').value = data.username || "";
      document.getElementById('avatar-preview').src = data.avatar || "";
    }

    document.getElementById('saveProfile').onclick = async ()=>{
      const user = auth.currentUser;
      const name = document.getElementById('username').value;
      const file = document.getElementById('avatar').files[0];
      let avatarURL = "";
      if(file){
        const ref = storage.ref(`avatars/${user.uid}`);
        await ref.put(file);
        avatarURL = await ref.getDownloadURL();
      }
      await db.collection("users").doc(user.uid).update({username:name,avatar:avatarURL});
      alert("Profile updated!");
      showPage('chat');
    };

    // ========== SETTINGS ==========
    document.getElementById('settingsBtn').onclick = ()=>showPage('settings');
    document.getElementById('backSettings').onclick = ()=>showPage('chat');

    document.getElementById('deleteAccount').onclick = async ()=>{
      const user = auth.currentUser;
      if(confirm("Delete your account permanently?")){
        await db.collection("users").doc(user.uid).delete();
        await user.delete();
        alert("Account deleted");
        showPage('login');
      }
    };
  </script>
</body>
</html>