<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chamow Private Chat</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { margin: 0; background: #121212; color: #fff; }
    .container { max-width: 450px; margin: 50px auto; background: #1e1e1e; border-radius: 15px; overflow: hidden; box-shadow: 0 0 20px #000; }
    header { background: #6200ea; padding: 15px; text-align: center; font-weight: bold; font-size: 1.3em; }
    form { display: flex; flex-direction: column; padding: 20px; }
    input { margin: 8px 0; padding: 10px; border-radius: 8px; border: none; outline: none; }
    button { padding: 10px; background: #6200ea; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; transition: 0.2s; }
    button:hover { background: #7e57c2; }
    .error { color: #ff5252; font-size: 0.9em; margin-top: -5px; }
    .hidden { display: none; }

    #chatPage, #profilePage, #settingsPage, #messagePage { display: none; }
    .chatList, .messages { height: 400px; overflow-y: auto; padding: 10px; }
    .message { padding: 8px 12px; margin: 5px 0; border-radius: 10px; max-width: 80%; font-size: 0.95em; }
    .sent { background: #4a148c; align-self: flex-end; }
    .received { background: #333; align-self: flex-start; }
    .timestamp { font-size: 0.75em; opacity: 0.6; margin-top: 2px; text-align: right; }

    .user { display: flex; align-items: center; padding: 10px; cursor: pointer; border-bottom: 1px solid #333; }
    .user img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .user-status { font-size: 0.8em; opacity: 0.7; }

    .nav { display: flex; justify-content: space-around; background: #333; padding: 10px; }
    .nav button { background: transparent; border: none; color: #fff; font-size: 1.2em; }

    .typing { font-size: 0.9em; opacity: 0.7; padding: 5px; text-align: center; }
  </style>
</head>
<body>

  <!-- AUTH PAGE -->
  <div class="container" id="authPage">
    <header>üî• Chamow Chat</header>

    <form id="loginForm">
      <h3>Login</h3>
      <input type="email" id="loginEmail" placeholder="Email" required />
      <input type="password" id="loginPassword" placeholder="Password" required />
      <p class="error" id="loginError"></p>
      <button type="submit">Login</button>
      <button type="button" id="forgotPassword">Forgot Password?</button>
      <p>Don't have an account? <a href="#" id="showRegister">Register</a></p>
    </form>

    <form id="registerForm" class="hidden">
      <h3>Register</h3>
      <input type="text" id="registerName" placeholder="Full Name" required />
      <input type="email" id="registerEmail" placeholder="Email" required />
      <input type="password" id="registerPassword" placeholder="Password (min 6 chars)" required />
      <p class="error" id="registerError"></p>
      <button type="submit">Register</button>
      <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
    </form>
  </div>

  <!-- CHAT LIST PAGE -->
  <div class="container" id="chatPage">
    <header id="chatHeader">Chats</header>
    <div class="chatList" id="chatList"></div>
    <div class="nav">
      <button onclick="showChatList()">üí¨</button>
      <button onclick="openProfile()">üë§</button>
      <button onclick="openSettings()">‚öôÔ∏è</button>
    </div>
  </div>

  <!-- MESSAGE PAGE -->
  <div class="container" id="messagePage">
    <header id="chatUserHeader">Chat</header>
    <div class="typing" id="typingIndicator"></div>
    <div class="messages" id="messages"></div>
    <form id="messageForm" style="display:flex; padding:10px;">
      <input type="text" id="messageInput" placeholder="Type a message..." style="flex:1;" required />
      <button type="submit">Send</button>
    </form>
    <p class="error" id="messageError" style="text-align:center;"></p>
  </div>

  <!-- PROFILE PAGE -->
  <div class="container" id="profilePage">
    <header>My Profile</header>
    <div style="padding:20px;">
      <img id="profileAvatar" src="" width="100" height="100" style="border-radius:50%; display:block; margin:auto;" />
      <input type="file" id="avatarInput" />
      <input type="text" id="profileName" placeholder="Your name" />
      <p class="error" id="profileError"></p>
      <button onclick="saveProfile()">Save</button>
    </div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="container" id="settingsPage">
    <header>Settings</header>
    <div style="padding:20px; text-align:center;">
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    // üî• Firebase Config
    const firebaseConfig = {
  apiKey: "AIzaSyB1fQdrmOJWDh4dEdQTFucj9BUeQmH_yew",
  authDomain: "whatsapp-web-944f9.firebaseapp.com",
  databaseURL: "https://whatsapp-web-944f9-default-rtdb.firebaseio.com",
  projectId: "whatsapp-web-944f9",
  storageBucket: "whatsapp-web-944f9.firebasestorage.app",
  messagingSenderId: "975370289693",
  appId: "1:975370289693:web:23390019b3b1c216a0fcf4"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const authPage = document.getElementById('authPage');
    const chatPage = document.getElementById('chatPage');
    const messagePage = document.getElementById('messagePage');
    const profilePage = document.getElementById('profilePage');
    const settingsPage = document.getElementById('settingsPage');

    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const typingIndicator = document.getElementById('typingIndicator');

    let currentUser = null;
    let currentChatUser = null;
    let typingTimeout;

    // üîÑ Switch forms
    document.getElementById('showRegister').onclick = () => {
      registerForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
      loginError.textContent = '';
    };
    document.getElementById('showLogin').onclick = () => {
      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      registerError.textContent = '';
    };

    // üßæ Register user
    registerForm.onsubmit = async (e) => {
      e.preventDefault();
      const name = registerName.value.trim();
      const email = registerEmail.value.trim();
      const password = registerPassword.value.trim();
      registerError.textContent = '';

      if (!name || !email || !password) {
        registerError.textContent = 'Please fill in all fields.';
        return;
      }
      if (password.length < 6) {
        registerError.textContent = 'Password must be at least 6 characters.';
        return;
      }

      try {
        const userCred = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(userCred.user.uid).set({
          name, email, avatar: '', online: true, lastSeen: firebase.firestore.FieldValue.serverTimestamp(), uid: userCred.user.uid
        });
      } catch (err) {
        registerError.textContent = err.message;
      }
    };

    // üîê Login user
    loginForm.onsubmit = async (e) => {
      e.preventDefault();
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      loginError.textContent = '';

      if (!email || !password) {
        loginError.textContent = 'Please fill in all fields.';
        return;
      }

      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (err) {
        loginError.textContent = err.message;
      }
    };

    // üîë Forgot password
    document.getElementById('forgotPassword').onclick = async () => {
      const email = prompt('Enter your registered email:');
      if (!email) return;
      try {
        await auth.sendPasswordResetEmail(email);
        alert('Password reset link sent! Check your email.');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };

    // üë§ Auth listener
    auth.onAuthStateChanged(async user => {
      if (user) {
        currentUser = user;
        await db.collection('users').doc(user.uid).update({ online: true });
        showChatList();
      } else {
        authPage.style.display = 'block';
        chatPage.style.display = 'none';
        messagePage.style.display = 'none';
      }
    });

    // üí¨ Chat list
    async function showChatList() {
      authPage.style.display = 'none';
      profilePage.style.display = 'none';
      settingsPage.style.display = 'none';
      messagePage.style.display = 'none';
      chatPage.style.display = 'block';

      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      const snapshot = await db.collection('users').get();

      snapshot.forEach(doc => {
        const user = doc.data();
        if (user.uid !== currentUser.uid) {
          const div = document.createElement('div');
          const lastSeen = user.online ? 'üü¢ Online' : 'Last seen: ' + (user.lastSeen?.toDate().toLocaleString() || 'Unknown');
          div.classList.add('user');
          div.innerHTML = `<img src="${user.avatar || 'https://i.ibb.co/2g8ghG5/user.png'}">
                           <div>
                             <div>${user.name}</div>
                             <div class="user-status">${lastSeen}</div>
                           </div>`;
          div.onclick = () => openChat(user);
          chatList.appendChild(div);
        }
      });
    }

    // üì© Chat window
    async function openChat(user) {
      currentChatUser = user;
      chatPage.style.display = 'none';
      messagePage.style.display = 'block';
      document.getElementById('chatUserHeader').innerText = user.name;

      const messagesDiv = document.getElementById('messages');
      const chatId = [currentUser.uid, user.uid].sort().join('_');
      const msgError = document.getElementById('messageError');

      // Typing listener
      db.collection('chats').doc(chatId).onSnapshot(doc => {
        if (doc.exists && doc.data().typing === user.uid) {
          typingIndicator.textContent = `${user.name} is typing...`;
        } else {
          typingIndicator.textContent = '';
        }
      });

      db.collection('chats').doc(chatId).collection('messages')
        .orderBy('timestamp').onSnapshot(snapshot => {
          messagesDiv.innerHTML = '';
          snapshot.forEach(doc => {
            const msg = doc.data();
            const div = document.createElement('div');
            div.classList.add('message', msg.sender === currentUser.uid ? 'sent' : 'received');
            div.innerHTML = `${msg.text}<div class="timestamp">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : ''}</div>`;
            messagesDiv.appendChild(div);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

      const msgForm = document.getElementById('messageForm');
      const msgInput = document.getElementById('messageInput');

      msgInput.addEventListener('input', () => {
        db.collection('chats').doc(chatId).set({ typing: currentUser.uid }, { merge: true });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          db.collection('chats').doc(chatId).set({ typing: '' }, { merge: true });
        }, 1500);
      });

      msgForm.onsubmit = async (e) => {
        e.preventDefault();
        const text = msgInput.value.trim();
        msgError.textContent = '';
        if (!text) {
          msgError.textContent = 'Message cannot be empty.';
          return;
        }
        await db.collection('chats').doc(chatId).collection('messages').add({
          text, sender: currentUser.uid, receiver: user.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgInput.value = '';
      };
    }

    // üë§ Profile
    async function openProfile() {
      chatPage.style.display = 'none';
      profilePage.style.display = 'block';
      const userDoc = await db.collection('users').doc(currentUser.uid).get();
      const user = userDoc.data();
      profileName.value = user.name || '';
      profileAvatar.src = user.avatar || 'https://i.ibb.co/2g8ghG5/user.png';
    }

    avatarInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (file) {
        const ref = storage.ref('avatars/' + currentUser.uid);
        await ref.put(file);
        const url = await ref.getDownloadURL();
        profileAvatar.src = url;
        await db.collection('users').doc(currentUser.uid).update({ avatar: url });
      }
    });

    async function saveProfile() {
      const name = profileName.value.trim();
      if (!name) {
        profileError.textContent = 'Name cannot be empty.';
        return;
      }
      await db.collection('users').doc(currentUser.uid).update({ name });
      alert('Profile updated!');
      showChatList();
    }

    function openSettings() {
      chatPage.style.display = 'none';
      settingsPage.style.display = 'block';
    }

    async function logout() {
      await db.collection('users').doc(currentUser.uid).update({
        online: false, lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      });
      await auth.signOut();
    }
  </script>
</body>
</html>